# 环境配置说明

## 系统要求

- **GPU**: NVIDIA RTX 4080S (16GB VRAM) 或同等性能GPU
- **CUDA**: 12.1 或更高版本
- **Python**: 3.10+
- **操作系统**: Linux (推荐) 或 Windows

## 快速配置（推荐）

### 1. 创建 Conda 虚拟环境

```bash
conda create -n A2_final python=3.10 -y
conda activate A2_final
```

### 2. 安装 PyTorch (CUDA 12.1)

```bash
pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu121
```

### 3. 安装其他依赖

```bash
pip install -r requirements.txt
```

### 4. 验证安装

```bash
python -c "import torch; print(f'PyTorch: {torch.__version__}'); print(f'CUDA: {torch.cuda.is_available()}')"
python test_setup.py
```

## 详细配置步骤

### 方法一：使用 pip（推荐）

```bash
# 1. 激活环境
conda activate A2_final

# 2. 安装 PyTorch（根据你的 CUDA 版本选择）
# CUDA 12.1
pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu121

# 或 CUDA 11.8
# pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu118

# 3. 安装项目依赖
pip install transformers>=4.44.0
pip install datasets>=2.14.0
pip install accelerate>=0.20.0
pip install evaluate>=0.4.0
pip install sacrebleu>=2.3.0
pip install sentencepiece>=0.1.99
pip install protobuf>=3.20.0
```

### 方法二：使用 requirements.txt

```bash
conda activate A2_final
pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu121
pip install -r requirements.txt
```

### 方法三：使用 conda（备选）

```bash
conda activate A2_final
conda install pytorch torchvision torchaudio pytorch-cuda=12.1 -c pytorch -c nvidia
pip install transformers datasets accelerate evaluate sacrebleu sentencepiece
```

## 常见问题

### Q1: 提示 transformers 版本过低

```bash
pip install --upgrade transformers>=4.44.0
```

### Q2: CUDA 不可用

检查 CUDA 版本：
```bash
nvidia-smi
```

重新安装匹配的 PyTorch 版本：
```bash
pip uninstall torch torchvision torchaudio
pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu121
```

### Q3: 出现 "undefined symbol: iJIT_NotifyEvent" 错误

```bash
conda install mkl mkl-service intel-openmp -y
pip install --force-reinstall torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu121
```

### Q4: tokenizers 并行警告

在训练脚本前添加：
```bash
export TOKENIZERS_PARALLELISM=false
```

## 开始训练

环境配置完成后，运行：

```bash
python main.py
```

预计训练时间：3-4小时（RTX 4080S，opus-mt-zh-en模型）

## 包版本说明

| 包名 | 推荐版本 | 说明 |
|-----|---------|------|
| torch | >=2.0.0 | 深度学习框架，需支持CUDA 12.1+ |
| transformers | >=4.44.0 | 避免旧版本的PyTorch加载问题 |
| datasets | >=2.14.0 | 数据集加载和处理 |
| accelerate | >=0.20.0 | 训练加速和分布式支持 |
| evaluate | >=0.4.0 | 评估指标计算 |
| sacrebleu | >=2.3.0 | BLEU分数计算 |

## 验证环境

```bash
# 检查 PyTorch 和 CUDA
python -c "import torch; print(f'PyTorch版本: {torch.__version__}'); print(f'CUDA可用: {torch.cuda.is_available()}'); print(f'GPU数量: {torch.cuda.device_count()}')"

# 检查 Transformers
python -c "import transformers; print(f'Transformers版本: {transformers.__version__}')"

# 运行完整测试
python test_setup.py
```

## 卸载环境

如需重新配置：

```bash
conda deactivate
conda env remove -n A2_final
```
